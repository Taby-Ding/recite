<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>背诵单词抗遗忘系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: none;
        }
        
        header {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .filter-section {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-card {
            flex: 1;
            min-width: 200px;
            background-color: #f0f2f5;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .filter-card h3 {
            color: #4A00E0;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .select-all-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(74, 0, 224, 0.3);
        }
        
        .select-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74, 0, 224, 0.4);
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
        }
        
        .filter-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .filter-option.selected {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border-color: #4A00E0;
        }
        
        .filter-option input {
            margin: 0;
            display: none;
        }
        
        .word-display {
            text-align: center;
            margin: 30px 0;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .word {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #4A00E0;
            word-break: break-word;
            max-width: 100%;
        }
        
        .translation {
            font-size: 2.2rem;
            color: #666;
            margin-bottom: 15px;
            word-break: break-word;
            max-width: 100%;
        }
        
        .pronunciation {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .speak-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #4A00E0;
            transition: all 0.3s ease;
        }
        
        .speak-btn:hover {
            color: #8E2DE2;
            transform: scale(1.1);
        }
        
        .progress {
            font-size: 1rem;
            color: #666;
            margin-top: 15px;
        }
        
        .btn-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            flex: 1;
            padding: 15px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            min-width: 120px;
        }
        
        .remember-btn {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
        }
        
        .not-remember-btn {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .action-btn:active {
            transform: translateY(1px);
        }
        
        .settings-panel {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            background-color: #f0f2f5;
            padding: 20px;
            border-radius: 15px;
        }
        
        .setting-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .setting-group label {
            font-weight: 600;
            color: #444;
        }
        
        /* 弹窗样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .modal h2 {
            color: #4A00E0;
            margin-bottom: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .upload-section {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px dashed #4A00E0;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 15px 0;
        }
        
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 0, 224, 0.3);
            white-space: nowrap;
        }
        
        .file-input-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(74, 0, 224, 0.4);
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            word-break: break-all;
        }
        
        .hint {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }
        
        .close-btn {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 0, 224, 0.3);
        }
        
        .results-modal .modal-content {
            max-width: 600px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }
        
        .stat-remember {
            color: #00b09b;
        }
        
        .stat-forget {
            color: #ff416c;
        }
        
        .copyright {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            color: #888;
            font-size: 0.9rem;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            header {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .word {
                font-size: 2.5rem;
            }
            
            .translation {
                font-size: 1.8rem;
            }
            
            .action-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .settings-panel {
                flex-direction: column;
                gap: 10px;
            }
            
            .setting-group {
                justify-content: space-between;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .modal h2 {
                font-size: 1.5rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .filter-section {
                flex-direction: column;
            }
            
            .filter-card {
                min-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .word {
                font-size: 2rem;
            }
            
            .translation {
                font-size: 1.5rem;
            }
            
            .action-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-width: 100px;
            }
            
            .btn-container {
                gap: 10px;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- 主容器 -->
    <div class="container" id="mainContainer">
        <header>
            <h1>背诵单词抗遗忘系统</h1>
            <p class="subtitle">每天五分钟，单词记心中</p>
        </header>
        
        <div class="main-content">
            <div class="filter-section" id="filterSection" style="display: none;">
                <div class="filter-card">
                    <h3>选择年级</h3>
                    <button class="select-all-btn" id="selectAllGrades">全选/取消</button>
                    <div class="filter-options" id="gradeOptions"></div>
                </div>
                <div class="filter-card">
                    <h3>选择单元</h3>
                    <button class="select-all-btn" id="selectAllUnits">全选/取消</button>
                    <div class="filter-options" id="unitOptions"></div>
                </div>
            </div>

            <div class="settings-panel">
                <div class="setting-group">
                    <input type="checkbox" id="showTranslation" checked>
                    <label for="showTranslation">显示中文释义</label>
                </div>
                <div class="setting-group">
                    <input type="checkbox" id="showWord" checked>
                    <label for="showWord">显示英文单词</label>
                </div>
                <div class="setting-group">
                    <input type="radio" name="order" id="sequential" value="sequential" checked>
                    <label for="sequential">顺序显示</label>
                </div>
                <div class="setting-group">
                    <input type="radio" name="order" id="random" value="random">
                    <label for="random">随机显示</label>
                </div>
            </div>

            <div class="word-display">
                <div id="wordDisplay" class="word"></div>
                <div id="translationDisplay" class="translation"></div>
                <div class="pronunciation">
                    <button class="speak-btn" id="audioBtn">🔊</button>
                </div>
            </div>

            <div class="progress">
                <span id="progressText">进度: <span id="currentProgress">0</span>/<span id="totalWords">0</span></span>
            </div>

            <div class="btn-container">
                <button id="rememberBtn" class="action-btn remember-btn">记住了</button>
                <button id="notRememberBtn" class="action-btn not-remember-btn">没记住</button>
            </div>
            
            <div class="copyright">
                © 2025 Taby-Ding 保留所有权利.
            </div>
        </div>
    </div>

    <!-- 文件上传弹窗 -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <h1>背诵单词抗遗忘系统</h1>
            <h2>导入单词表</h2>
            <div class="upload-section">
                <p>可自行上传Excel文件</p>
                <p>要求第一行为标题行</p>
  		<p>A列为英文单词（必选）</p>
		<p>B列为中文释义（必选）</p>
		<p>C列为年级（可选）</p>
		<p>D列为单元（可选）</p>

                <div class="file-input-wrapper">
                    <button class="file-input-btn">选择Excel文件</button>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
                </div>
                <div class="file-name" id="fileName">默认为人教版1-6年级单词</div>
                <p class="hint">支持.xlsx和.xls格式，点击开始学习直接使用默认单词表</p>
            </div>
            <button class="close-btn" id="startBtn">开始学习</button>
        </div>
    </div>

    <!-- 结束统计弹窗 -->
    <div class="modal results-modal" id="resultsModal" style="display: none;">
        <div class="modal-content">
            <h2>学习完成！</h2>
            <p>本次学习结果统计：</p>
            <div class="stats">
                <div class="stat">
                    <span class="stat-value stat-remember" id="rememberCount">0</span>
                    <span>已记住</span>
                </div>
                <div class="stat">
                    <span class="stat-value stat-forget" id="forgetCount">0</span>
                    <span>未记住</span>
                </div>
            </div>
            <button class="close-btn" id="restartBtn">重新开始</button>
        </div>
    </div>

    <script>
        // 单词数据存储
        let words = [];
        let filteredWords = [];
        let currentIndex = 0;
        let rememberedWords = [];
        let notRememberedWords = [];
        let currentOrder = 'sequential'; // 默认顺序
        let audio = null;
        let allGrades = new Set();
        let allUnits = new Set();
        let hasGradeColumn = false; // 标记是否有年级列
        let hasUnitColumn = false;  // 标记是否有单元列

        // DOM元素
        const mainContainer = document.getElementById('mainContainer');
        const uploadModal = document.getElementById('uploadModal');
        const resultsModal = document.getElementById('resultsModal');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const startBtn = document.getElementById('startBtn');
        const wordDisplay = document.getElementById('wordDisplay');
        const translationDisplay = document.getElementById('translationDisplay');
        const currentProgress = document.getElementById('currentProgress');
        const totalWords = document.getElementById('totalWords');
        const rememberBtn = document.getElementById('rememberBtn');
        const notRememberBtn = document.getElementById('notRememberBtn');
        const audioBtn = document.getElementById('audioBtn');
        const showTranslation = document.getElementById('showTranslation');
        const showWord = document.getElementById('showWord');
        const sequentialRadio = document.getElementById('sequential');
        const randomRadio = document.getElementById('random');
        const rememberCount = document.getElementById('rememberCount');
        const forgetCount = document.getElementById('forgetCount');
        const restartBtn = document.getElementById('restartBtn');
        const gradeOptions = document.getElementById('gradeOptions');
        const unitOptions = document.getElementById('unitOptions');
        const selectAllGradesBtn = document.getElementById('selectAllGrades');
        const selectAllUnitsBtn = document.getElementById('selectAllUnits');
        const filterSection = document.getElementById('filterSection');

        // 上传文件处理
        fileInput.addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileName.textContent = file.name;
        }

        // 页面加载时尝试加载默认文件
        //window.addEventListener('load', () => {
           // loadDefaultFile();
        //});

        // 加载默认文件
        function loadDefaultFile() {
            // 创建一个隐藏的链接元素用于发起请求
            const link = document.createElement('a');
            link.href = './words.xlsx';
            link.style.display = 'none';
            document.body.appendChild(link);
            
            // 使用fetch尝试获取默认文件
            fetch('./words.xlsx')
                .then(response => {
                    if (response.ok) {
                        return response.arrayBuffer();
                    } else {
                        throw new Error('默认文件不存在');
                    }
                })
                .then(arrayBuffer => {
                    try {
                        const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                        // 验证数据格式（跳过第一行标题行）
                        if (jsonData.length <= 1) {
                            throw new Error('Excel文件中没有找到有效的单词数据');
                        }

                        // 检查必需列A和B
                        const firstDataRow = jsonData[1]; // 获取第一行数据
                        if (firstDataRow.length < 2 || !firstDataRow[0] || !firstDataRow[1]) {
                            throw new Error('Excel文件中A列（单词）或B列（释义）为空或缺失');
                        }

                        words = [];
                        allGrades = new Set();
                        allUnits = new Set();
                        hasGradeColumn = false;
                        hasUnitColumn = false;
                        
                        // 检查是否包含C列和D列
                        const firstRow = jsonData[0]; // 标题行
                        if (firstRow && firstRow.length >= 3) {
                            hasGradeColumn = true;
                        }
                        if (firstRow && firstRow.length >= 4) {
                            hasUnitColumn = true;
                        }
                        
                        for (let i = 1; i < jsonData.length; i++) { // 从第2行开始读取数据
                            const row = jsonData[i];
                            if (row.length >= 2 && row[0] && row[1]) { // 确保A、B列存在且非空
                                const wordData = {
                                    word: row[0].toString().trim(),
                                    translation: row[1].toString().trim(),
                                    grade: hasGradeColumn && row[2] ? row[2].toString().trim() : null,
                                    unit: hasUnitColumn && row[3] ? row[3].toString().trim() : null
                                };
                                words.push(wordData);
                                if (hasGradeColumn && wordData.grade) allGrades.add(wordData.grade);
                                if (hasUnitColumn && wordData.unit) allUnits.add(wordData.unit);
                            }
                        }

                        if (words.length === 0) {
                            throw new Error('未找到有效的单词数据（A列：单词，B列：中文释义）');
                        }

                        // 初始化
                        currentIndex = 0;
                        rememberedWords = [];
                        notRememberedWords = [];
                        
                        // 根据是否存在C、D列决定是否显示筛选UI
                        if (hasGradeColumn || hasUnitColumn) {
                            createFilterOptions();
                            applyFilters(); // 应用筛选（默认选中所有）
                            filterSection.style.display = 'flex'; // 显示筛选区域
                        } else {
                            // 没有C、D列，直接使用所有单词
                            filteredWords = words;
                            totalWords.textContent = filteredWords.length;
                            filterSection.style.display = 'none'; // 隐藏筛选区域
                            showCurrentWord();
                        }
                        
                        // 隐藏上传弹窗，显示主界面
                        uploadModal.style.display = 'none';
                        mainContainer.style.display = 'block';
                        
                        console.log('已加载默认文件');
                    } catch (error) {
                        console.error('默认文件加载失败:', error);
                        // 默认文件加载失败，继续显示上传界面
                        fileName.textContent = '使用默认文件失败，请选择文件';
                    }
                })
                .catch(error => {
                    console.error('默认文件加载失败:', error);
                    // 默认文件加载失败，继续显示上传界面
                    fileName.textContent = '未找到默认文件words.xlsx，请选择文件';
                });
            
            document.body.removeChild(link);
        }

        // 开始学习按钮
        startBtn.addEventListener('click', function() {
            // 优先使用用户上传的文件
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                        // 验证数据格式（跳过第一行标题行）
                        if (jsonData.length <= 1) {
                            throw new Error('Excel文件中没有找到有效的单词数据');
                        }

                        // 检查必需列A和B
                        const firstDataRow = jsonData[1]; // 获取第一行数据
                        if (firstDataRow.length < 2 || !firstDataRow[0] || !firstDataRow[1]) {
                            throw new Error('Excel文件中A列（单词）或B列（释义）为空或缺失');
                        }

                        words = [];
                        allGrades = new Set();
                        allUnits = new Set();
                        hasGradeColumn = false;
                        hasUnitColumn = false;
                        
                        // 检查是否包含C列和D列
                        const firstRow = jsonData[0]; // 标题行
                        if (firstRow && firstRow.length >= 3) {
                            hasGradeColumn = true;
                        }
                        if (firstRow && firstRow.length >= 4) {
                            hasUnitColumn = true;
                        }
                        
                        for (let i = 1; i < jsonData.length; i++) { // 从第2行开始读取数据
                            const row = jsonData[i];
                            if (row.length >= 2 && row[0] && row[1]) { // 确保A、B列存在且非空
                                const wordData = {
                                    word: row[0].toString().trim(),
                                    translation: row[1].toString().trim(),
                                    grade: hasGradeColumn && row[2] ? row[2].toString().trim() : null,
                                    unit: hasUnitColumn && row[3] ? row[3].toString().trim() : null
                                };
                                words.push(wordData);
                                if (hasGradeColumn && wordData.grade) allGrades.add(wordData.grade);
                                if (hasUnitColumn && wordData.unit) allUnits.add(wordData.unit);
                            }
                        }

                        if (words.length === 0) {
                            throw new Error('未找到有效的单词数据（A列：单词，B列：中文释义）');
                        }

                        // 初始化
                        currentIndex = 0;
                        rememberedWords = [];
                        notRememberedWords = [];
                        
                        // 根据是否存在C、D列决定是否显示筛选UI
                        if (hasGradeColumn || hasUnitColumn) {
                            createFilterOptions();
                            applyFilters(); // 应用筛选（默认选中所有）
                            filterSection.style.display = 'flex'; // 显示筛选区域
                        } else {
                            // 没有C、D列，直接使用所有单词
                            filteredWords = words;
                            totalWords.textContent = filteredWords.length;
                            filterSection.style.display = 'none'; // 隐藏筛选区域
                            showCurrentWord();
                        }
                        
                        // 隐藏上传弹窗，显示主界面
                        uploadModal.style.display = 'none';
                        mainContainer.style.display = 'block';
                    } catch (error) {
                        console.error('文件解析错误:', error);
                        alert('文件解析失败: ' + error.message);
                    }
                };
                reader.onerror = function() {
                    alert('文件读取失败');
                };
                reader.readAsArrayBuffer(file);
            } else {
                // 如果没有上传文件，则尝试加载默认文件
                loadDefaultFile();
            }
        });

        // 创建筛选选项
        function createFilterOptions() {
            // 清空之前的选项
            gradeOptions.innerHTML = '';
            unitOptions.innerHTML = '';

            // 创建年级选项 (仅当存在年级列时)
            if (hasGradeColumn) {
                allGrades.forEach(grade => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'filter-option';
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="grade_${grade}" value="${grade}" checked>
                        <label for="grade_${grade}">${grade}</label>
                    `;
                    gradeOptions.appendChild(optionDiv);
                    
                    // 添加点击事件
                    optionDiv.addEventListener('click', function() {
                        const checkbox = optionDiv.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        if (checkbox.checked) {
                            optionDiv.classList.add('selected');
                        } else {
                            optionDiv.classList.remove('selected');
                        }
                        applyFilters();
                    });
                    
                    // 初始化选中状态
                    if (optionDiv.querySelector('input').checked) {
                        optionDiv.classList.add('selected');
                    }
                });
            } else {
                gradeOptions.innerHTML = '<div class="filter-option" style="background-color: #ccc; color: #666; cursor: default;">未找到年级列</div>';
                selectAllGradesBtn.disabled = true;
            }

            // 创建单元选项 (仅当存在单元列时)
            if (hasUnitColumn) {
                allUnits.forEach(unit => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'filter-option';
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="unit_${unit}" value="${unit}" checked>
                        <label for="unit_${unit}">${unit}</label>
                    `;
                    unitOptions.appendChild(optionDiv);
                    
                    // 添加点击事件
                    optionDiv.addEventListener('click', function() {
                        const checkbox = optionDiv.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        if (checkbox.checked) {
                            optionDiv.classList.add('selected');
                        } else {
                            optionDiv.classList.remove('selected');
                        }
                        applyFilters();
                    });
                    
                    // 初始化选中状态
                    if (optionDiv.querySelector('input').checked) {
                        optionDiv.classList.add('selected');
                    }
                });
            } else {
                unitOptions.innerHTML = '<div class="filter-option" style="background-color: #ccc; color: #666; cursor: default;">未找到单元列</div>';
                selectAllUnitsBtn.disabled = true;
            }
            
            // 添加全选/取消按钮事件
            if (hasGradeColumn) {
                selectAllGradesBtn.addEventListener('click', function() {
                    const allCheckboxes = gradeOptions.querySelectorAll('input[type="checkbox"]');
                    if (allCheckboxes.length === 0) return; // 如果没有可选项，直接返回
                    const allSelected = Array.from(allCheckboxes).every(cb => cb.checked);
                    
                    allCheckboxes.forEach(checkbox => {
                        checkbox.checked = !allSelected;
                        const optionDiv = checkbox.parentElement;
                        if (!allSelected) {
                            optionDiv.classList.add('selected');
                        } else {
                            optionDiv.classList.remove('selected');
                        }
                    });
                    
                    applyFilters();
                });
            }
            
            if (hasUnitColumn) {
                selectAllUnitsBtn.addEventListener('click', function() {
                    const allCheckboxes = unitOptions.querySelectorAll('input[type="checkbox"]');
                    if (allCheckboxes.length === 0) return; // 如果没有可选项，直接返回
                    const allSelected = Array.from(allCheckboxes).every(cb => cb.checked);
                    
                    allCheckboxes.forEach(checkbox => {
                        checkbox.checked = !allSelected;
                        const optionDiv = checkbox.parentElement;
                        if (!allSelected) {
                            optionDiv.classList.add('selected');
                        } else {
                            optionDiv.classList.remove('selected');
                        }
                    });
                    
                    applyFilters();
                });
            }
        }

        // 应用筛选
        function applyFilters() {
            if (!hasGradeColumn && !hasUnitColumn) {
                // 如果没有C、D列，直接使用所有单词
                filteredWords = words;
            } else {
                const selectedGrades = hasGradeColumn ? 
                    Array.from(document.querySelectorAll('#gradeOptions input[type="checkbox"]:checked'))
                        .map(cb => cb.value) : [];
                const selectedUnits = hasUnitColumn ? 
                    Array.from(document.querySelectorAll('#unitOptions input[type="checkbox"]:checked'))
                        .map(cb => cb.value) : [];
                
                filteredWords = words.filter(word => {
                    const gradeMatch = !hasGradeColumn || (word.grade && selectedGrades.includes(word.grade));
                    const unitMatch = !hasUnitColumn || (word.unit && selectedUnits.includes(word.unit));
                    return gradeMatch && unitMatch;
                });
            }
            
            // 重置索引和进度
            currentIndex = 0;
            totalWords.textContent = filteredWords.length;
            
            // 如果有筛选结果，显示第一个单词；否则显示提示
            if (filteredWords.length > 0) {
                showCurrentWord();
            } else {
                wordDisplay.textContent = '未找到匹配的单词';
                translationDisplay.textContent = '请选择其他年级或单元';
                currentProgress.textContent = '0';
            }
        }

        // 更新进度显示
        function updateProgress() {
            currentProgress.textContent = currentIndex + 1;
            totalWords.textContent = filteredWords.length;
        }

        // 显示当前单词
        function showCurrentWord() {
            // 检查是否已完成所有单词
            if (currentIndex >= filteredWords.length) {
                showResults();
                return;
            }

            const wordData = filteredWords[currentIndex];
            wordDisplay.textContent = showWord.checked ? wordData.word : '???';
            translationDisplay.textContent = showTranslation.checked ? wordData.translation : '???';
            
            updateProgress();
        }

        // 播放发音
        audioBtn.addEventListener('click', function() {
            if (currentIndex < filteredWords.length) {
                const word = filteredWords[currentIndex].word;
                const audioUrl = `http://dict.youdao.com/dictvoice?audio=${encodeURIComponent(word)}&type=2`;
                
                if (audio) {
                    audio.pause();
                }
                audio = new Audio(audioUrl);
                audio.play().catch(e => {
                    console.error('音频播放失败:', e);
                    alert('音频播放失败');
                });
            }
        });

        // 记住按钮事件
        rememberBtn.addEventListener('click', function() {
            if (currentIndex < filteredWords.length) {
                rememberedWords.push(filteredWords[currentIndex]);
                currentIndex++;
                showCurrentWord();
            }
        });

        // 没记住按钮事件
        notRememberBtn.addEventListener('click', function() {
            if (currentIndex < filteredWords.length) {
                notRememberedWords.push(filteredWords[currentIndex]);
                currentIndex++;
                showCurrentWord();
            }
        });

        // 顺序/随机切换
        sequentialRadio.addEventListener('change', function() {
            if (this.checked) {
                currentOrder = 'sequential';
            }
        });

        randomRadio.addEventListener('change', function() {
            if (this.checked) {
                currentOrder = 'random';
                shuffleWords();
                currentIndex = 0;
                showCurrentWord();
            }
        });

        // 随机打乱单词顺序
        function shuffleWords() {
            for (let i = filteredWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [filteredWords[i], filteredWords[j]] = [filteredWords[j], filteredWords[i]];
            }
        }

        // 显示结果
        function showResults() {
            // 计算统计信息
            const total = filteredWords.length;
            const remembered = rememberedWords.length;
            const notRemembered = notRememberedWords.length;
            
            // 更新结果界面
            rememberCount.textContent = remembered;
            forgetCount.textContent = notRemembered;
            
            // 显示结果弹窗
            resultsModal.style.display = 'flex';
        }

        // 重新开始 - 仅重置学习状态，不跳转到上传页面
        restartBtn.addEventListener('click', function() {
            // 隐藏结果弹窗，保持主界面显示
            resultsModal.style.display = 'none';
            
            // 重置学习相关状态，但保留单词数据和筛选状态
            currentIndex = 0;
            rememberedWords = [];
            notRememberedWords = [];
            
            // 重新应用筛选以确保filteredWords是最新的（如果筛选条件有变化）
            applyFilters(); // 这会重置currentIndex到0
            
            // 重新显示第一个单词
            showCurrentWord();
        });

        // 显示/隐藏控制
        showTranslation.addEventListener('change', showCurrentWord);
        showWord.addEventListener('change', showCurrentWord);
    </script>
</body>
</html>
