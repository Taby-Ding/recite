<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èƒŒè¯µå•è¯æŠ—é—å¿˜ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: none;
        }
        
        header {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .filter-section {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-card {
            flex: 1;
            min-width: 200px;
            background-color: #f0f2f5;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .filter-card h3 {
            color: #4A00E0;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .select-all-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(74, 0, 224, 0.3);
        }
        
        .select-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(74, 0, 224, 0.4);
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background-color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
        }
        
        .filter-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .filter-option.selected {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border-color: #4A00E0;
        }
        
        .filter-option input {
            margin: 0;
            display: none;
        }
        
        .word-display {
            text-align: center;
            margin: 30px 0;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .word {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: #4A00E0;
            word-break: break-word;
            max-width: 100%;
        }
        
        .translation {
            font-size: 2.2rem;
            color: #666;
            margin-bottom: 15px;
            word-break: break-word;
            max-width: 100%;
        }
        
        .pronunciation {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .speak-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #4A00E0;
            transition: all 0.3s ease;
        }
        
        .speak-btn:hover {
            color: #8E2DE2;
            transform: scale(1.1);
        }
        
        .progress {
            font-size: 1rem;
            color: #666;
            margin-top: 15px;
        }
        
        .btn-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            flex: 1;
            padding: 15px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            min-width: 120px;
        }
        
        .remember-btn {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
        }
        
        .not-remember-btn {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .action-btn:active {
            transform: translateY(1px);
        }
        
        .settings-panel {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            background-color: #f0f2f5;
            padding: 20px;
            border-radius: 15px;
        }
        
        .setting-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .setting-group label {
            font-weight: 600;
            color: #444;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .modal h2 {
            color: #4A00E0;
            margin-bottom: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .upload-section {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px dashed #4A00E0;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 15px 0;
        }
        
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 0, 224, 0.3);
            white-space: nowrap;
        }
        
        .file-input-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(74, 0, 224, 0.4);
        }
        
        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            word-break: break-all;
        }
        
        .hint {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }
        
        .close-btn {
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 0, 224, 0.3);
        }
        
        .results-modal .modal-content {
            max-width: 600px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }
        
        .stat-remember {
            color: #00b09b;
        }
        
        .stat-forget {
            color: #ff416c;
        }
        
        .copyright {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            color: #888;
            font-size: 0.9rem;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            header {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .word {
                font-size: 2.5rem;
            }
            
            .translation {
                font-size: 1.8rem;
            }
            
            .action-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .settings-panel {
                flex-direction: column;
                gap: 10px;
            }
            
            .setting-group {
                justify-content: space-between;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .modal h2 {
                font-size: 1.5rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .filter-section {
                flex-direction: column;
            }
            
            .filter-card {
                min-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .word {
                font-size: 2rem;
            }
            
            .translation {
                font-size: 1.5rem;
            }
            
            .action-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-width: 100px;
            }
            
            .btn-container {
                gap: 10px;
            }
            
            .stat-value {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- ä¸»å®¹å™¨ -->
    <div class="container" id="mainContainer">
        <header>
            <h1>èƒŒè¯µå•è¯æŠ—é—å¿˜ç³»ç»Ÿ</h1>
            <p class="subtitle">æ¯å¤©äº”åˆ†é’Ÿï¼Œå•è¯è®°å¿ƒä¸­</p>
        </header>
        
        <div class="main-content">
            <div class="filter-section" id="filterSection" style="display: none;">
                <div class="filter-card">
                    <h3>é€‰æ‹©å¹´çº§</h3>
                    <button class="select-all-btn" id="selectAllGrades">å…¨é€‰/å–æ¶ˆ</button>
                    <div class="filter-options" id="gradeOptions"></div>
                </div>
                <div class="filter-card">
                    <h3>é€‰æ‹©å•å…ƒ</h3>
                    <button class="select-all-btn" id="selectAllUnits">å…¨é€‰/å–æ¶ˆ</button>
                    <div class="filter-options" id="unitOptions"></div>
                </div>
            </div>

            <div class="settings-panel">
                <div class="setting-group">
                    <input type="checkbox" id="showTranslation" checked>
                    <label for="showTranslation">æ˜¾ç¤ºä¸­æ–‡é‡Šä¹‰</label>
                </div>
                <div class="setting-group">
                    <input type="checkbox" id="showWord" checked>
                    <label for="showWord">æ˜¾ç¤ºè‹±æ–‡å•è¯</label>
                </div>
                <div class="setting-group">
                    <input type="radio" name="order" id="sequential" value="sequential" checked>
                    <label for="sequential">é¡ºåºæ˜¾ç¤º</label>
                </div>
                <div class="setting-group">
                    <input type="radio" name="order" id="random" value="random">
                    <label for="random">éšæœºæ˜¾ç¤º</label>
                </div>
            </div>

            <div class="word-display">
                <div id="wordDisplay" class="word"></div>
                <div id="translationDisplay" class="translation"></div>
                <div class="pronunciation">
                    <button class="speak-btn" id="audioBtn">ğŸ”Š</button>
                </div>
            </div>

            <div class="progress">
                <span id="progressText">è¿›åº¦: <span id="currentProgress">0</span>/<span id="totalWords">0</span></span>
            </div>

            <div class="btn-container">
                <button id="rememberBtn" class="action-btn remember-btn">è®°ä½äº†</button>
                <button id="notRememberBtn" class="action-btn not-remember-btn">æ²¡è®°ä½</button>
            </div>
            
            <div class="copyright">
                Â© 2025 Taby-Ding ä¿ç•™æ‰€æœ‰æƒåˆ©.
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ å¼¹çª— -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <h1>èƒŒè¯µå•è¯æŠ—é—å¿˜ç³»ç»Ÿ</h1>
            <h2>å¯¼å…¥å•è¯è¡¨</h2>
            <div class="upload-section">
                <p>å¯è‡ªè¡Œä¸Šä¼ Excelæ–‡ä»¶</p>
                <p>è¦æ±‚ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜è¡Œ</p>
  		<p>Aåˆ—ä¸ºè‹±æ–‡å•è¯ï¼ˆå¿…é€‰ï¼‰</p>
		<p>Båˆ—ä¸ºä¸­æ–‡é‡Šä¹‰ï¼ˆå¿…é€‰ï¼‰</p>
		<p>Cåˆ—ä¸ºå¹´çº§ï¼ˆå¯é€‰ï¼‰</p>
		<p>Dåˆ—ä¸ºå•å…ƒï¼ˆå¯é€‰ï¼‰</p>

                <div class="file-input-wrapper">
                    <button class="file-input-btn">é€‰æ‹©Excelæ–‡ä»¶</button>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls">
                </div>
                <div class="file-name" id="fileName">é»˜è®¤ä¸ºäººæ•™ç‰ˆ1-6å¹´çº§å•è¯</div>
                <p class="hint">æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼ï¼Œç‚¹å‡»å¼€å§‹å­¦ä¹ ç›´æ¥ä½¿ç”¨é»˜è®¤å•è¯è¡¨</p>
            </div>
            <button class="close-btn" id="startBtn">å¼€å§‹å­¦ä¹ </button>
        </div>
    </div>

    <!-- ç»“æŸç»Ÿè®¡å¼¹çª— -->
    <div class="modal results-modal" id="resultsModal" style="display: none;">
        <div class="modal-content">
            <h2>å­¦ä¹ å®Œæˆï¼</h2>
            <p>æœ¬æ¬¡å­¦ä¹ ç»“æœç»Ÿè®¡ï¼š</p>
            <div class="stats">
                <div class="stat">
                    <span class="stat-value stat-remember" id="rememberCount">0</span>
                    <span>å·²è®°ä½</span>
                </div>
                <div class="stat">
                    <span class="stat-value stat-forget" id="forgetCount">0</span>
                    <span>æœªè®°ä½</span>
                </div>
            </div>
            <button class="close-btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
    </div>

    <script>
        // å•è¯æ•°æ®å­˜å‚¨
        let words = [];
        let filteredWords = [];
        let currentIndex = 0;
        let rememberedWords = [];
        let notRememberedWords = [];
        let currentOrder = 'sequential'; // é»˜è®¤é¡ºåº
        let audio = null;
        let allGrades = new Set();
        let allUnits = new Set();
        let hasGradeColumn = false; // æ ‡è®°æ˜¯å¦æœ‰å¹´çº§åˆ—
        let hasUnitColumn = false;  // æ ‡è®°æ˜¯å¦æœ‰å•å…ƒåˆ—

        // DOMå…ƒç´ 
        const mainContainer = document.getElementById('mainContainer');
        const uploadModal = document.getElementById('uploadModal');
        const resultsModal = document.getElementById('resultsModal');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const startBtn = document.getElementById('startBtn');
        const wordDisplay = document.getElementById('wordDisplay');
        const translationDisplay = document.getElementById('translationDisplay');
        const currentProgress = document.getElementById('currentProgress');
        const totalWords = document.getElementById('totalWords');
        const rememberBtn = document.getElementById('rememberBtn');
        const notRememberBtn = document.getElementById('notRememberBtn');
        const audioBtn = document.getElementById('audioBtn');
        const showTranslation = document.getElementById('showTranslation');
        const showWord = document.getElementById('showWord');
        const sequentialRadio = document.getElementById('sequential');
        const randomRadio = document.getElementById('random');
        const rememberCount = document.getElementById('rememberCount');
        const forgetCount = document.getElementById('forgetCount');
        const restartBtn = document.getElementById('restartBtn');
        const gradeOptions = document.getElementById('gradeOptions');
        const unitOptions = document.getElementById('unitOptions');
        const selectAllGradesBtn = document.getElementById('selectAllGrades');
        const selectAllUnitsBtn = document.getElementById('selectAllUnits');
        const filterSection = document.getElementById('filterSection');

        // ä¸Šä¼ æ–‡ä»¶å¤„ç†
        fileInput.addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileName.textContent = file.name;
        }

        // é¡µé¢åŠ è½½æ—¶å°è¯•åŠ è½½é»˜è®¤æ–‡ä»¶
        //window.addEventListener('load', () => {
           // loadDefaultFile();
        //});

        // åŠ è½½é»˜è®¤æ–‡ä»¶
        function loadDefaultFile() {
            // åˆ›å»ºä¸€ä¸ªéšè—çš„é“¾æ¥å…ƒç´ ç”¨äºå‘èµ·è¯·æ±‚
            const link = document.createElement('a');
            link.href = './words.xlsx';
            link.style.display = 'none';
            document.body.appendChild(link);
            
            // ä½¿ç”¨fetchå°è¯•è·å–é»˜è®¤æ–‡ä»¶
            fetch('./words.xlsx')
                .then(response => {
                    if (response.ok) {
                        return response.arrayBuffer();
                    } else {
                        throw new Error('é»˜è®¤æ–‡ä»¶ä¸å­˜åœ¨');
                    }
                })
                .then(arrayBuffer => {
                    try {
                        const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                        // éªŒè¯æ•°æ®æ ¼å¼ï¼ˆè·³è¿‡ç¬¬ä¸€è¡Œæ ‡é¢˜è¡Œï¼‰
                        if (jsonData.length <= 1) {
                            throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å•è¯æ•°æ®');
                        }

                        // æ£€æŸ¥å¿…éœ€åˆ—Aå’ŒB
                        const firstDataRow = jsonData[1]; // è·å–ç¬¬ä¸€è¡Œæ•°æ®
                        if (firstDataRow.length < 2 || !firstDataRow[0] || !firstDataRow[1]) {
                            throw new Error('Excelæ–‡ä»¶ä¸­Aåˆ—ï¼ˆå•è¯ï¼‰æˆ–Båˆ—ï¼ˆé‡Šä¹‰ï¼‰ä¸ºç©ºæˆ–ç¼ºå¤±');
                        }

                        words = [];
                        allGrades = new Set();
                        allUnits = new Set();
                        hasGradeColumn = false;
                        hasUnitColumn = false;
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«Cåˆ—å’ŒDåˆ—
                        const firstRow = jsonData[0]; // æ ‡é¢˜è¡Œ
                        if (firstRow && firstRow.length >= 3) {
                            hasGradeColumn = true;
                        }
                        if (firstRow && firstRow.length >= 4) {
                            hasUnitColumn = true;
                        }
                        
                        for (let i = 1; i < jsonData.length; i++) { // ä»ç¬¬2è¡Œå¼€å§‹è¯»å–æ•°æ®
                            const row = jsonData[i];
                            if (row.length >= 2 && row[0] && row[1]) { // ç¡®ä¿Aã€Båˆ—å­˜åœ¨ä¸”éç©º
                                const wordData = {
                                    word: row[0].toString().trim(),
                                    translation: row[1].toString().trim(),
                                    grade: hasGradeColumn && row[2] ? row[2].toString().trim() : null,
                                    unit: hasUnitColumn && row[3] ? row[3].toString().trim() : null
                                };
                                words.push(wordData);
                                if (hasGradeColumn && wordData.grade) allGrades.add(wordData.grade);
                                if (hasUnitColumn && wordData.unit) allUnits.add(wordData.unit);
                            }
                        }

                        if (words.length === 0) {
                            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„å•è¯æ•°æ®ï¼ˆAåˆ—ï¼šå•è¯ï¼ŒBåˆ—ï¼šä¸­æ–‡é‡Šä¹‰ï¼‰');
                        }

                        // åˆå§‹åŒ–
                        currentIndex = 0;
                        rememberedWords = [];
                        notRememberedWords = [];
                        
                        // æ ¹æ®æ˜¯å¦å­˜åœ¨Cã€Dåˆ—å†³å®šæ˜¯å¦æ˜¾ç¤ºç­›é€‰UI
                        if (hasGradeColumn || hasUnitColumn) {
                            createFilterOptions();
                            applyFilters(); // åº”ç”¨ç­›é€‰ï¼ˆé»˜è®¤é€‰ä¸­æ‰€æœ‰ï¼‰
                            filterSection.style.display = 'flex'; // æ˜¾ç¤ºç­›é€‰åŒºåŸŸ
                        } else {
                            // æ²¡æœ‰Cã€Dåˆ—ï¼Œç›´æ¥ä½¿ç”¨æ‰€æœ‰å•è¯
                            filteredWords = words;
                            totalWords.textContent = filteredWords.length;
                            filterSection.style.display = 'none'; // éšè—ç­›é€‰åŒºåŸŸ
                            showCurrentWord();
                        }
                        
                        // éšè—ä¸Šä¼ å¼¹çª—ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
                        uploadModal.style.display = 'none';
                        mainContainer.style.display = 'block';
                        
                        console.log('å·²åŠ è½½é»˜è®¤æ–‡ä»¶');
                    } catch (error) {
                        console.error('é»˜è®¤æ–‡ä»¶åŠ è½½å¤±è´¥:', error);
                        // é»˜è®¤æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œç»§ç»­æ˜¾ç¤ºä¸Šä¼ ç•Œé¢
                        fileName.textContent = 'ä½¿ç”¨é»˜è®¤æ–‡ä»¶å¤±è´¥ï¼Œè¯·é€‰æ‹©æ–‡ä»¶';
                    }
                })
                .catch(error => {
                    console.error('é»˜è®¤æ–‡ä»¶åŠ è½½å¤±è´¥:', error);
                    // é»˜è®¤æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œç»§ç»­æ˜¾ç¤ºä¸Šä¼ ç•Œé¢
                    fileName.textContent = 'æœªæ‰¾åˆ°é»˜è®¤æ–‡ä»¶words.xlsxï¼Œè¯·é€‰æ‹©æ–‡ä»¶';
                });
            
            document.body.removeChild(link);
        }

        // å¼€å§‹å­¦ä¹ æŒ‰é’®
        startBtn.addEventListener('click', function() {
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                        // éªŒè¯æ•°æ®æ ¼å¼ï¼ˆè·³è¿‡ç¬¬ä¸€è¡Œæ ‡é¢˜è¡Œï¼‰
                        if (jsonData.length <= 1) {
                            throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å•è¯æ•°æ®');
                        }

                        // æ£€æŸ¥å¿…éœ€åˆ—Aå’ŒB
                        const firstDataRow = jsonData[1]; // è·å–ç¬¬ä¸€è¡Œæ•°æ®
                        if (firstDataRow.length < 2 || !firstDataRow[0] || !firstDataRow[1]) {
                            throw new Error('Excelæ–‡ä»¶ä¸­Aåˆ—ï¼ˆå•è¯ï¼‰æˆ–Båˆ—ï¼ˆé‡Šä¹‰ï¼‰ä¸ºç©ºæˆ–ç¼ºå¤±');
                        }

                        words = [];
                        allGrades = new Set();
                        allUnits = new Set();
                        hasGradeColumn = false;
                        hasUnitColumn = false;
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«Cåˆ—å’ŒDåˆ—
                        const firstRow = jsonData[0]; // æ ‡é¢˜è¡Œ
                        if (firstRow && firstRow.length >= 3) {
                            hasGradeColumn = true;
                        }
                        if (firstRow && firstRow.length >= 4) {
                            hasUnitColumn = true;
                        }
                        
                        for (let i = 1; i < jsonData.length; i++) { // ä»ç¬¬2è¡Œå¼€å§‹è¯»å–æ•°æ®
                            const row = jsonData[i];
                            if (row.length >= 2 && row[0] && row[1]) { // ç¡®ä¿Aã€Båˆ—å­˜åœ¨ä¸”éç©º
                                const wordData = {
                                    word: row[0].toString().trim(),
                                    translation: row[1].toString().trim(),
                                    grade: hasGradeColumn && row[2] ? row[2].toString().trim() : null,
                                    unit: hasUnitColumn && row[3] ? row[3].toString().trim() : null
                                };
                                words.push(wordData);
                                if (hasGradeColumn && wordData.grade) allGrades.add(wordData.grade);
                                if (hasUnitColumn && wordData.unit) allUnits.add(wordData.unit);
                            }
                        }

                        if (words.length === 0) {
                            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„å•è¯æ•°æ®ï¼ˆAåˆ—ï¼šå•è¯ï¼ŒBåˆ—ï¼šä¸­æ–‡é‡Šä¹‰ï¼‰');
                        }

                        // åˆå§‹åŒ–
                        currentIndex = 0;
                        rememberedWords = [];
                        notRememberedWords = [];
                        
                        // æ ¹æ®æ˜¯å¦å­˜åœ¨Cã€Dåˆ—å†³å®šæ˜¯å¦æ˜¾ç¤ºç­›é€‰UI
                        if (hasGradeColumn || hasUnitColumn) {
                            createFilterOptions();
                            applyFilters(); // åº”ç”¨ç­›é€‰ï¼ˆé»˜è®¤é€‰ä¸­æ‰€æœ‰ï¼‰
                            filterSection.style.display = 'flex'; // æ˜¾ç¤ºç­›é€‰åŒºåŸŸ
                        } else {
                            // æ²¡æœ‰Cã€Dåˆ—ï¼Œç›´æ¥ä½¿ç”¨æ‰€æœ‰å•è¯
                            filteredWords = words;
                            totalWords.textContent = filteredWords.length;
                            filterSection.style.display = 'none'; // éšè—ç­›é€‰åŒºåŸŸ
                            showCurrentWord();
                        }
                        
                        // éšè—ä¸Šä¼ å¼¹çª—ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
                        uploadModal.style.display = 'none';
                        mainContainer.style.display = 'block';
                    } catch (error) {
                        console.error('æ–‡ä»¶è§£æé”™è¯¯:', error);
                        alert('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                    }
                };
                reader.onerror = function() {
                    alert('æ–‡ä»¶è¯»å–å¤±è´¥');
                };
                reader.readAsArrayBuffer(file);
            } else {
                // å¦‚æœæ²¡æœ‰ä¸Šä¼ æ–‡ä»¶ï¼Œåˆ™å°è¯•åŠ è½½é»˜è®¤æ–‡ä»¶
                loadDefaultFile();
            }
        });

        // åˆ›å»ºç­›é€‰é€‰é¡¹
        function createFilterOptions() {
            // æ¸…ç©ºä¹‹å‰çš„é€‰é¡¹
            gradeOptions.innerHTML = '';
            unitOptions.innerHTML = '';

            // åˆ›å»ºå¹´çº§é€‰é¡¹ (ä»…å½“å­˜åœ¨å¹´çº§åˆ—æ—¶)
            if (hasGradeColumn) {
                allGrades.forEach(grade => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'filter-option';
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="grade_${grade}" value="${grade}" checked>
                        <label for="grade_${grade}">${grade}</label>
                    `;
                    gradeOptions.appendChild(optionDiv);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    optionDiv.addEventListener('click', function() {
                        const checkbox = optionDiv.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        if (checkbox.checked) {
                            optionDiv.classList.add('selected');
                        } else {
                            optionDiv.classList.remove('selected');
                        }
                        applyFilters();
                    });
                    
                    // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
                    if (optionDiv.querySelector('input').checked) {
                        optionDiv.classList.add('selected');
                    }
                });
            } else {
                gradeOptions.innerHTML = '<div class="filter-option" style="background-color: #ccc; color: #666; cursor: default;">æœªæ‰¾åˆ°å¹´çº§åˆ—</div>';
                selectAllGradesBtn.disabled = true;
            }

            // åˆ›å»ºå•å…ƒé€‰é¡¹ (ä»…å½“å­˜åœ¨å•å…ƒåˆ—æ—¶)
            if (hasUnitColumn) {
                allUnits.forEach(unit => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'filter-option';
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="unit_${unit}" value="${unit}" checked>
                        <label for="unit_${unit}">${unit}</label>
                    `;
                    unitOptions.appendChild(optionDiv);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    optionDiv.addEventListener('click', function() {
                        const checkbox = optionDiv.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        if (checkbox.checked) {
                            optionDiv.classList.add('selected');
                        } else {
                            optionDiv.classList.remove('selected');
                        }
                        applyFilters();
                    });
                    
                    // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
                    if (optionDiv.querySelector('input').checked) {
                        optionDiv.classList.add('selected');
                    }
                });
            } else {
                unitOptions.innerHTML = '<div class="filter-option" style="background-color: #ccc; color: #666; cursor: default;">æœªæ‰¾åˆ°å•å…ƒåˆ—</div>';
                selectAllUnitsBtn.disabled = true;
            }
            
            // æ·»åŠ å…¨é€‰/å–æ¶ˆæŒ‰é’®äº‹ä»¶
            if (hasGradeColumn) {
                selectAllGradesBtn.addEventListener('click', function() {
                    const allCheckboxes = gradeOptions.querySelectorAll('input[type="checkbox"]');
                    if (allCheckboxes.length === 0) return; // å¦‚æœæ²¡æœ‰å¯é€‰é¡¹ï¼Œç›´æ¥è¿”å›
                    const allSelected = Array.from(allCheckboxes).every(cb => cb.checked);
                    
                    allCheckboxes.forEach(checkbox => {
                        checkbox.checked = !allSelected;
                        const optionDiv = checkbox.parentElement;
                        if (!allSelected) {
                            optionDiv.classList.add('selected');
                        } else {
                            optionDiv.classList.remove('selected');
                        }
                    });
                    
                    applyFilters();
                });
            }
            
            if (hasUnitColumn) {
                selectAllUnitsBtn.addEventListener('click', function() {
                    const allCheckboxes = unitOptions.querySelectorAll('input[type="checkbox"]');
                    if (allCheckboxes.length === 0) return; // å¦‚æœæ²¡æœ‰å¯é€‰é¡¹ï¼Œç›´æ¥è¿”å›
                    const allSelected = Array.from(allCheckboxes).every(cb => cb.checked);
                    
                    allCheckboxes.forEach(checkbox => {
                        checkbox.checked = !allSelected;
                        const optionDiv = checkbox.parentElement;
                        if (!allSelected) {
                            optionDiv.classList.add('selected');
                        } else {
                            optionDiv.classList.remove('selected');
                        }
                    });
                    
                    applyFilters();
                });
            }
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            if (!hasGradeColumn && !hasUnitColumn) {
                // å¦‚æœæ²¡æœ‰Cã€Dåˆ—ï¼Œç›´æ¥ä½¿ç”¨æ‰€æœ‰å•è¯
                filteredWords = words;
            } else {
                const selectedGrades = hasGradeColumn ? 
                    Array.from(document.querySelectorAll('#gradeOptions input[type="checkbox"]:checked'))
                        .map(cb => cb.value) : [];
                const selectedUnits = hasUnitColumn ? 
                    Array.from(document.querySelectorAll('#unitOptions input[type="checkbox"]:checked'))
                        .map(cb => cb.value) : [];
                
                filteredWords = words.filter(word => {
                    const gradeMatch = !hasGradeColumn || (word.grade && selectedGrades.includes(word.grade));
                    const unitMatch = !hasUnitColumn || (word.unit && selectedUnits.includes(word.unit));
                    return gradeMatch && unitMatch;
                });
            }
            
            // é‡ç½®ç´¢å¼•å’Œè¿›åº¦
            currentIndex = 0;
            totalWords.textContent = filteredWords.length;
            
            // å¦‚æœæœ‰ç­›é€‰ç»“æœï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªå•è¯ï¼›å¦åˆ™æ˜¾ç¤ºæç¤º
            if (filteredWords.length > 0) {
                showCurrentWord();
            } else {
                wordDisplay.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„å•è¯';
                translationDisplay.textContent = 'è¯·é€‰æ‹©å…¶ä»–å¹´çº§æˆ–å•å…ƒ';
                currentProgress.textContent = '0';
            }
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress() {
            currentProgress.textContent = currentIndex + 1;
            totalWords.textContent = filteredWords.length;
        }

        // æ˜¾ç¤ºå½“å‰å•è¯
        function showCurrentWord() {
            // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰å•è¯
            if (currentIndex >= filteredWords.length) {
                showResults();
                return;
            }

            const wordData = filteredWords[currentIndex];
            wordDisplay.textContent = showWord.checked ? wordData.word : '???';
            translationDisplay.textContent = showTranslation.checked ? wordData.translation : '???';
            
            updateProgress();
        }

        // æ’­æ”¾å‘éŸ³
        audioBtn.addEventListener('click', function() {
            if (currentIndex < filteredWords.length) {
                const word = filteredWords[currentIndex].word;
                const audioUrl = `http://dict.youdao.com/dictvoice?audio=${encodeURIComponent(word)}&type=2`;
                
                if (audio) {
                    audio.pause();
                }
                audio = new Audio(audioUrl);
                audio.play().catch(e => {
                    console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                    alert('éŸ³é¢‘æ’­æ”¾å¤±è´¥');
                });
            }
        });

        // è®°ä½æŒ‰é’®äº‹ä»¶
        rememberBtn.addEventListener('click', function() {
            if (currentIndex < filteredWords.length) {
                rememberedWords.push(filteredWords[currentIndex]);
                currentIndex++;
                showCurrentWord();
            }
        });

        // æ²¡è®°ä½æŒ‰é’®äº‹ä»¶
        notRememberBtn.addEventListener('click', function() {
            if (currentIndex < filteredWords.length) {
                notRememberedWords.push(filteredWords[currentIndex]);
                currentIndex++;
                showCurrentWord();
            }
        });

        // é¡ºåº/éšæœºåˆ‡æ¢
        sequentialRadio.addEventListener('change', function() {
            if (this.checked) {
                currentOrder = 'sequential';
            }
        });

        randomRadio.addEventListener('change', function() {
            if (this.checked) {
                currentOrder = 'random';
                shuffleWords();
                currentIndex = 0;
                showCurrentWord();
            }
        });

        // éšæœºæ‰“ä¹±å•è¯é¡ºåº
        function shuffleWords() {
            for (let i = filteredWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [filteredWords[i], filteredWords[j]] = [filteredWords[j], filteredWords[i]];
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const total = filteredWords.length;
            const remembered = rememberedWords.length;
            const notRemembered = notRememberedWords.length;
            
            // æ›´æ–°ç»“æœç•Œé¢
            rememberCount.textContent = remembered;
            forgetCount.textContent = notRemembered;
            
            // æ˜¾ç¤ºç»“æœå¼¹çª—
            resultsModal.style.display = 'flex';
        }

        // é‡æ–°å¼€å§‹ - ä»…é‡ç½®å­¦ä¹ çŠ¶æ€ï¼Œä¸è·³è½¬åˆ°ä¸Šä¼ é¡µé¢
        restartBtn.addEventListener('click', function() {
            // éšè—ç»“æœå¼¹çª—ï¼Œä¿æŒä¸»ç•Œé¢æ˜¾ç¤º
            resultsModal.style.display = 'none';
            
            // é‡ç½®å­¦ä¹ ç›¸å…³çŠ¶æ€ï¼Œä½†ä¿ç•™å•è¯æ•°æ®å’Œç­›é€‰çŠ¶æ€
            currentIndex = 0;
            rememberedWords = [];
            notRememberedWords = [];
            
            // é‡æ–°åº”ç”¨ç­›é€‰ä»¥ç¡®ä¿filteredWordsæ˜¯æœ€æ–°çš„ï¼ˆå¦‚æœç­›é€‰æ¡ä»¶æœ‰å˜åŒ–ï¼‰
            applyFilters(); // è¿™ä¼šé‡ç½®currentIndexåˆ°0
            
            // é‡æ–°æ˜¾ç¤ºç¬¬ä¸€ä¸ªå•è¯
            showCurrentWord();
        });

        // æ˜¾ç¤º/éšè—æ§åˆ¶
        showTranslation.addEventListener('change', showCurrentWord);
        showWord.addEventListener('change', showCurrentWord);
    </script>
</body>
</html>
